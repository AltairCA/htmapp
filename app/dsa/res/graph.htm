<?global
	
#include "cpp/index_thread.h"

?><?c

	// Start the indexer thread if we got a root
	str::t_string sRoot = in[ "GET" ][ "root" ].str();
	if ( sRoot.length() )	
	{
		// Ensure valid drive
		t_pb job;
		if ( disk::GetDiskInfo( job[ "drive" ], sRoot ) )
		{	
			// Set the job information
			job[ "params" ] = in[ "GET" ];
			job[ "top" ] = 5;
			job[ "depth" ] = 3;
			job[ "run" ] = 1;
			
			// Set the job info
			tq::set( "indexer.job", job, "." );

			// Ensure indexer thread is running
			tq::start( "indexer", index_thread );

		} // end if

	} // end if

?>
<body>
    <div id="chart"></div>
	<script type="text/javascript">
		var w = 640,
			h = 480,
			r = Math.min(w, h) / 2,
			color = d3.scale.category20c();

		var vis = d3.select("#chart").append("svg")
			.attr("width", w)
			.attr("height", h)
			.append("g")
			.attr("transform", "translate(" + w / 2 + "," + h / 2 + ")");

		var partition = d3.layout.partition()
			.sort(null)
			.size([2 * Math.PI, r * r])
			//.value(function(d) { return 1; });
			.value(function(d) { return d.size; });

		var arc = d3.svg.arc()
			.startAngle(function(d) { return d.x; })
			.endAngle(function(d) { return d.x + d.dx; })
			.innerRadius(function(d) { return Math.sqrt(d.y); })
			.outerRadius(function(d) { return Math.sqrt(d.y + d.dy); });

		function notzero( a )
		{
			for ( var i in a )
				return true;
			return false;
		}

		function poll_data()
		{
			$.ajax({ url: "data.htm", 
					 dataType: "json",
					 success: function(json) 
					 {	
						if ( json.drive )
							setProgress( json.drive.progress, json.drive.total );
					 
						if ( json.map && notzero( json.map ) )
						{
							var path = vis
							   .data([json.map])
							   .selectAll("path")
							   .data(partition.nodes)
							   .attr("d", arc)
//							   .attr("fill-rule", "evenodd")
//							   .style("stroke", "#222")
							   .style("fill", function(d) 
							   { 	if ( d.path == $('.highlight').html() )
									{	$('.highlight').html( d.path );
										$('.hdr_size').html( d.szstr );
										return d.hi_colour;
									} // end if
									else
										return d.colour; 
							   })
//							   .style("fill", function(d) { return color((d.children ? d : d.parent).name); })
								;
/*
							path
							   .style("stroke", "#F00")
							   .transition()
							   .duration(2000)
							   .style("stroke", "#222")
//							   .attrTween("d", arcTween)
								;
*/								
							path
							   .enter().append("path")
							   .attr("display", function(d) { return d.depth ? null : "none"; })
							   .attr("d", arc)
//							   .attr("fill-rule", "evenodd")
							   .style("stroke", "#222")
							   .style("fill", function(d) { return d.colour; })
//							   .style("fill", function(d) { return color((d.children ? d : d.parent).name); })
							   .on("mouseover", function(d)
							   {	$('.highlight').html( d.path );
									$('.hdr_size').html( d.szstr );
									d3.select(this).style("fill", d.hi_colour);
							   })
							   .on("mouseout", function(d)
							   {	$('.selitem').html( '' );
									d3.select(this).style("fill", d.colour);
							   })
							   .each(stash)
							   ;
							   
							path
								.exit()
								.remove()
								;
								
						} // end if
						
						setTimeout( poll_data, 1000 );
					 },
					 error: function(xhr,opt,msg) { setTimeout( poll_data, 1000 ); },
				});
		}
			
		setTimeout( poll_data, 1000 );

		// Stash the old values for transition.
		function stash(d) {
		  d.x0 = d.x;
		  d.dx0 = d.dx;
		}

		// Interpolate the arcs in data space.
		function arcTween(a) {
		  var i = d3.interpolate({x: a.x0, dx: a.dx0}, a);
		  return function(t) {
			var b = i(t);
			a.x0 = b.x;
			a.dx0 = b.dx;
			return arc(b);
		  };
		}
	</script>
</body>

