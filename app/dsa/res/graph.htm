<body>
    <div id="chart"></div>
	<script type="text/javascript">
		var w = 640,
			h = 480,
			r = Math.min(w, h) / 2,
			color = d3.scale.category20c();

		var vis = d3.select("#chart").append("svg")
			.attr("width", w)
			.attr("height", h)
			.append("g")
			.attr("transform", "translate(" + w / 2 + "," + h / 2 + ")");

		var partition = d3.layout.partition()
			.sort(null)
			.size([2 * Math.PI, r * r])
			//.value(function(d) { return 1; });
			.value(function(d) { return d.size; });

		var arc = d3.svg.arc()
			.startAngle(function(d) { return d.x; })
			.endAngle(function(d) { return d.x + d.dx; })
			.innerRadius(function(d) { return Math.sqrt(d.y); })
			.outerRadius(function(d) { return Math.sqrt(d.y + d.dy); });

		function notzero( a )
		{
			for ( var i in a )
				return true;
			return false;
		}

			function doAnimation()
			{
				vis.select(this)
					//.transition()
					//.duration(1000)
					;
			}
			
		function poll_data()
		{
			$.ajax({ url: "data.htm", 
					 dataType: "json",
					 success: function(json) 
					 {	
						if ( notzero( json ) )
						{
							var path = vis
							   .data([json])
							   .selectAll("path")
//							   .transition()
//							   .duration(500)
							   .data(partition.nodes)
							   .on("mousedown", function()
							   { 
									path
										.transition()
										.duration(1000)
										.style("stroke","#F22"); 
							   })
					   
//							   .attr("display", function(d) { return d.depth ? null : "none"; }) // hide inner ring
							   .attr("d", arc)
//							   .attr("fill-rule", "evenodd")
							   .style("stroke", "#222")
							   .style("fill", function(d) { return color((d.children ? d : d.parent).name); })
//							   .transition()
//							   .duration(500)
//							   .attrTween("d", arcTween)
								;
								
							path
							   .enter().append("path")
//							   .attr("display", function(d) { return d.depth ? null : "none"; }) // hide inner ring
							   .attr("d", arc)
//							   .attr("fill-rule", "evenodd")
							   .style("stroke", "#222")
							   .style("fill", function(d) { return color((d.children ? d : d.parent).name); })
							   .each(stash)
							   ;
							   
							path
								.exit()
								.remove()
								;
								
						} // end if
						
						setTimeout( poll_data, 3000 );
					 },
					 error: function(xhr,opt,msg) { setTimeout( poll_data, 1000 ); },
				});
		}
			
		setTimeout( poll_data, 3000 );

		// Stash the old values for transition.
		function stash(d) {
		  d.x0 = d.x;
		  d.dx0 = d.dx;
		}

		// Interpolate the arcs in data space.
		function arcTween(a) {
		  var i = d3.interpolate({x: a.x0, dx: a.dx0}, a);
		  return function(t) {
			var b = i(t);
			a.x0 = b.x;
			a.dx0 = b.dx;
			return arc(b);
		  };
		}
	</script>
</body>

